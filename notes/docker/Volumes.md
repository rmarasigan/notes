# [Docker Volumes](https://phoenixnap.com/kb/docker-volumes)

**Docker images** are stored as series of read-only layers. When we start a container, Docker takes the read-only image and adds a read-write layer on top. If the running container modifies an existing file, the file is copied out of the underlying read-only layer and into the top-most read-write layer where the changes are applied. The version in the read-write layer hides the underlying file, but does not destroy it -- it still exists in the underlying layer. When a Docker container is deleted, relaunching the image will start a fresh container without any of the changes made in the previously running container -- those changes are lost. Docker calls this combination of read-only layers with a read-write layer on top a **Union File System**.

**Docker volumes** are file systems mounted on Docker containers to preserve data generated by the running container. The volumes are stored on the host, independent of the container life cycle. This allows users to back up data and share file systems between containers easily.

## 3 Types of Volumes

* A **host volume** lives on the Docker host’s filesystem and can be accessed from within the container.
* A **named volume** is a volume which Docker manages where on disk the volume is created, but it is given a name.
* An **anonymous volume** is similar to a named volume, however, it can be difficult, to refer to the same volume over time when it is an anonymous volumes. Docker handle where the files are stored.

## 2 options for containers to store files

* **Volumes** are stored in a part of the host filesystem.
* **Bind mounts** may be stored anywhere on the host system.

## Types of Mounts

* **Volumes**
  
> Stored in a part of the host filesystem, *managed by Docker* (/var/lib/docker/volumes/ on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker. When we create a volume, it is stored within a directory on the Docker host. Volumes are managed by Docker and are isolated from the core functionality of the host machine. When we mount a volume, it may be **named** or **anonymous**. Anonymous volumes are not given an explicit name when they are first mounted into a container, so Docker gives them a random name guaranteed to be unique within a given Docker host. Besides the name, named and anonymous volumes behave in the same ways.

* **Bind mounts**

> May be *stored anywhere on the host* system. They may be important system files or directories. Non-Docker processes on the Docker host or a Docker container can modify them at any time. Bind mounts have limited functionality compared to volumes. When we use a bind mount, a file or directory on the host machine is mounted into a container. The file or directory is referenced by its full path on the host machine. The file or directory does not need to exist on the Docker host already. It is created on-demand if it does not yet exist. If we want to develop new Docker applications, then *consider using named volumes instead of bind mounts*. We can't use Docker CLI commands to directly manage bind mounts.

* **tmpfsmounts**

> Stored in the host system's memory only and are never written to the host system's filesystem. It is not persisted on disk, either on the Docker host or within a container. **tmpfs** mount can be used during the container's lifetime to store non-persistent state or sensitive information.

* **named pipes**

> Can be used for communication between the Docker host and a container. The common use case is to run a third-party tool inside a container and connect to the Docker Engine API using a named pipe.

## -v or --mount flag

The `-v` or `--volume` flag was used for standalone containers and the `--mount` flag was used for swarm services. In general, `--mount` is more explicit and verbose. The biggest difference is that the `-v` syntax combines all the options in one field, while the `--mount` syntax separates them.

1. `-v` or `--volume`

> Consists of three fields, separated by colon characters (:).
> * In the case of **named volumes**, the first field is the name of the volume, and it is unique on a given host machine. For **anonymous volumes**, the first field is omitted.
> * The second field is the path where the file or directory is mounted in the container.
> * The third field is an optional and comma-separated list of options.

2. `--mount`

> Consists of multiple key-value pairs, separated by commas and each consisting of a `<key>=<value>`. The `--mount` syntax is more verbose than `-v` or `--volume`. The order of the keys is not significant, but the flag's value is easier to understand.
> * The typeof the mount, which can be `volume`, `bind`, or `tmpfs`.
> * The destination takes as its value the path where the file or directory is mounted in the container. It may be specified as the `destination`, `dst`, or `target`.
> * If the `read-only` option present causes the bind mount to be mounted into the container as read-only.
> * The `volume-opt` option, which can be specified more than once, takes a key-value pair consisting of the option name and its value.

## Create a Docker Volume

Docker automatically creates a directory for the volume on the host under the **/var/lib/docker/volume/** path. You can now mount this volume on a container, ensuring data persistence and [data sharing among multiple containers](https://phoenixnap.com/kb/how-to-share-data-between-docker-containers).

```Bash
dev@dev:~$ docker volume create [volume_name]
dev@dev:~$ docker volume create data
```

## List Docker Volumes

The output displays a list of volumes, specifying their **location (DRIVER)** and their **VOLUME NAME**.

```Bash
dev@dev:~$ docker volume ls
DRIVER    VOLUME NAME
local     data
```

## Inspecting Docker Volumes

It lists details of a volume, including its location on the host file (**Mountpoint**). Everything stored within the data volume can also be found in the directory listed under the mountpoint path.

```Bash
dev@dev:~$ docker volume inspect [volume_name]

dev@dev:~$ docker volume inspect data
[
  {
    "CreatedAt": "2021-09-04T12:42:29+08:00",
    "Driver": "local",
    "Mountpoint": "/var/lib/docker/volumes/data/_data",
    "Name": "data",
    "Options": {},
    "Scope": "local"
  }
]
```

## Mounting a Data Volume

To mount a data volume to a container add the `--mount` flag to the docker run command. It adds the volume to the specified container, where it stores the data produced inside the virtual environment.

```Bash
dev@dev:~$ docker run --mount source=[volume_name],destination=[path_in_container] [docker_image]

dev@dev:~$ docker run -it --name=example1 --mount source=data,destination=/data ubuntu
```

The command instructs Docker to run a container in interactive mode (`-it`) from the Ubuntu image, under the name `example1`, while mounting the volume data in the `/data` directory inside the container.

## Mounting a Host Directory as a Data volume

You can also mount an existing directory from the host machine to a container. This type of volume is called **Host Volumes**. You can mount host volumes by using the `-v` flag and specifying the name of the host directory. Everything within the host directory is then available in the container. What’s more, all the data generated inside the container and placed in the data volume is safely stored on the host directory.

```Bash
dev@dev:~$ docker run -v "$(pwd)":[volume_name] [docker_image]
```

The **`$(pwd)`** attribute instructs Docker to mount the directory the user is currently in.

## Volume Permission and Ownership

Volume permissions can be changed by configuring the ownership within the Dockerfile. Use the `RUN` instruction and the `chown` command to set the Docker volume permission. Make sure this instruction precedes the line defining the `VOLUME`. Alternatively, you can change the ownership of the directory used as the host volume.

## Remove Docker Volumes

```Bash
# delete specific volume
dev@dev:~$ docker volume rm [volume_name]
```

## Delete Docker Volumes

```Bash
# delete all unused Docker volumes
dev@dev:~$ docker volume prune
```

### Reference:

* [Union File System](https://docs.docker.com/glossary/#union-file-system)
* [What is Docker Volume?](https://www.javatpoint.com/what-is-docker-volume)
* [Understanding Volumes in Docker](https://blog.container-solutions.com/understanding-volumes-docker)
* [Docker Volumes: How to Create & Get Started](https://phoenixnap.com/kb/docker-volumes)
